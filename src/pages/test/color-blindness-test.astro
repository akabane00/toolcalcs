---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AdUnit from '../../components/AdUnit.astro';
import { getGameBySlug } from '../../data/games';
import '../../styles/game.css';

const game = getGameBySlug('color-blindness-test')!;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://toolcalcs.com/" },
    { "@type": "ListItem", "position": 2, "name": "Tests & Games", "item": "https://toolcalcs.com/test/" },
    { "@type": "ListItem", "position": 3, "name": "Color Blindness Test" }
  ]
};
---

<BaseLayout
  title="Color Blindness Test - Test Your Color Vision Online | ToolCalcs"
  description="Test your color vision with this interactive color blindness test. Find the different colored tile in a grid that gets progressively harder. Free online color perception test."
  type="article"
  structuredData={structuredData}
>
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="/">Home</a> &rsaquo;
    <a href="/test/">Tests & Games</a> &rsaquo;
    <span>Color Blindness Test</span>
  </nav>

  <h1>Color Blindness Test</h1>
  <p class="page-desc">Find the tile that's a different color. Each level makes the difference more subtle. How far can you see?</p>

  <div class="game-box">
    <div class="game-area" id="gameArea" role="region" aria-label="Color blindness test area" aria-live="polite">
      <div class="game-instructions" id="instructionsView">
        <h2>Color Vision Test</h2>
        <p>A grid of colored tiles will appear. One tile is a slightly different color. Tap or click it to advance. You have 3 lives.</p>
        <button class="game-btn primary" id="startBtn" type="button" style="margin-top:16px;">Start Test</button>
      </div>

      <div class="play-view" id="playView" style="display:none;">
        <div class="status-bar">
          <span class="level-info" id="levelInfo">Level 1</span>
          <span class="lives-info" id="livesInfo">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
        </div>
        <div class="tile-grid" id="tileGrid" role="grid" aria-label="Color grid"></div>
      </div>

      <div class="result-view" id="resultView" style="display:none;">
        <div class="result-icon" aria-hidden="true">üé®</div>
        <div class="result-label">Game Over</div>
        <div class="score-display">
          <span class="score-value" id="finalScore">0</span>
          <span class="score-unit">levels completed</span>
        </div>
        <div class="rating-badge" id="ratingBadge">‚Äî</div>
        <button class="game-btn primary" id="tryAgainBtn" type="button" style="margin-top:16px;">Try Again</button>
      </div>
    </div>

    <div class="attempt-history" id="attemptHistory" hidden>
      <h3>Attempt History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <AdUnit slot="game-mid" format="horizontal" />

  <article class="content-section">
    <h2>What Is a Color Blindness Test?</h2>
    <p>A color blindness test assesses your ability to distinguish between different colors. Approximately 8% of men and 0.5% of women worldwide have some form of color vision deficiency. This test measures your color discrimination ability ‚Äî how subtle a color difference you can detect ‚Äî rather than diagnosing specific types of color blindness.</p>
    <p>While clinical color vision tests like the Ishihara plate test use specially designed patterns to identify specific deficiencies (protanopia, deuteranopia, tritanopia), this interactive test focuses on overall color perception acuity. It progressively reduces the color difference between tiles, testing the limits of your color discrimination ability.</p>

    <h2>How This Test Works</h2>
    <p>The test displays a grid of identically colored tiles with one tile that is a slightly different shade. Your task is to identify and click the different tile. With each successful level, the color difference becomes more subtle and the grid may grow larger, making it increasingly challenging to spot the odd tile.</p>
    <ul>
      <li><strong>Levels 1-5:</strong> Noticeable color differences on a small grid. Most people can complete these easily.</li>
      <li><strong>Levels 6-15:</strong> The differences become more subtle. You need good color discrimination to continue.</li>
      <li><strong>Levels 16-30:</strong> Very subtle differences that challenge even people with excellent color vision.</li>
      <li><strong>Levels 31+:</strong> Extremely subtle differences that only those with exceptional color perception can detect.</li>
    </ul>
    <p>You start with 3 lives. Clicking the wrong tile costs one life. The game ends when all lives are lost.</p>

    <h2>Types of Color Vision Deficiency</h2>
    <p>Color blindness comes in several forms, each affecting the perception of different parts of the color spectrum:</p>
    <ul>
      <li><strong>Protanopia/Protanomaly:</strong> Reduced sensitivity to red light. Red appears darker and may be confused with green, brown, or black. Affects about 1% of males.</li>
      <li><strong>Deuteranopia/Deuteranomaly:</strong> Reduced sensitivity to green light. The most common form, affecting about 6% of males. Greens and reds appear similar.</li>
      <li><strong>Tritanopia/Tritanomaly:</strong> Reduced sensitivity to blue light. Very rare, affecting less than 0.01% of people. Blue appears greenish and yellow appears pinkish.</li>
      <li><strong>Achromatopsia:</strong> Complete color blindness ‚Äî seeing only shades of gray. Extremely rare, affecting about 1 in 33,000 people.</li>
    </ul>

    <h2>Factors That Affect Color Perception</h2>
    <p>Several factors beyond genetic color vision deficiency can affect your performance on this test:</p>
    <ul>
      <li><strong>Screen quality:</strong> Display calibration, color gamut, and brightness significantly impact color rendering. IPS panels generally display colors more accurately than TN panels.</li>
      <li><strong>Viewing angle:</strong> Colors can shift when viewed from an angle, especially on lower-quality displays.</li>
      <li><strong>Ambient lighting:</strong> Room lighting affects how you perceive colors on screen. Consistent, moderate lighting is best.</li>
      <li><strong>Age:</strong> Color discrimination ability naturally decreases with age as the lens of the eye yellows.</li>
      <li><strong>Eye fatigue:</strong> Tired eyes are less effective at distinguishing subtle color differences.</li>
    </ul>

    <h2>Frequently Asked Questions</h2>

    <h3>Is this a medical-grade color blindness test?</h3>
    <p>No, this is an interactive color discrimination game, not a clinical diagnostic tool. For a definitive color vision assessment, consult an eye care professional who can administer standardized tests like the Ishihara test, Farnsworth D-15, or anomaloscope examination.</p>

    <h3>Can color blindness be cured?</h3>
    <p>Currently, genetic color vision deficiency cannot be cured. However, special corrective lenses (such as EnChroma glasses) can enhance color perception for some types of deficiency. Gene therapy research shows promise for future treatments. Acquired color vision changes due to medication or disease may be reversible by treating the underlying cause.</p>

    <h3>Why do some people see more colors than others?</h3>
    <p>Human color vision depends on cone cells in the retina. Most people have three types of cones (trichromatic vision). People with color deficiency have two functional types (dichromatic) or altered sensitivity in one type (anomalous trichromatic). A small percentage of women may have four types of cones (tetrachromacy), potentially allowing them to perceive millions more color distinctions.</p>
  </article>

  <AdUnit slot="game-bottom" format="horizontal" />
</BaseLayout>

<style>
  .game-area { cursor: default; user-select: auto; -webkit-user-select: auto; }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 12px;
  }
  .level-info {
    font-weight: 700;
    font-size: 1rem;
    color: var(--color-text);
  }
  .lives-info { font-size: 1.2rem; }

  .tile-grid {
    display: grid;
    gap: 4px;
    padding: 16px;
    max-width: 400px;
    margin: 0 auto;
  }
  :global(.color-tile) {
    aspect-ratio: 1;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.1s;
    border: none;
    padding: 0;
  }
  :global(.color-tile:hover) { transform: scale(0.95); }
  :global(.color-tile:active) { transform: scale(0.9); }
  :global(.color-tile.correct-flash) {
    animation: correctPulse 0.4s ease;
    box-shadow: 0 0 0 3px #16a34a;
  }
  :global(.color-tile.wrong-flash) {
    animation: wrongPulse 0.4s ease;
    box-shadow: 0 0 0 3px #ef4444;
  }
  @keyframes correctPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  @keyframes wrongPulse {
    0% { transform: scale(1); }
    25% { transform: translateX(-4px); }
    50% { transform: translateX(4px); }
    75% { transform: translateX(-4px); }
    100% { transform: scale(1); }
  }

  .play-view {
    min-height: 280px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .result-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 280px;
    padding: 24px;
  }
  .result-icon { font-size: 3rem; margin-bottom: 8px; }
  .result-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: 12px;
  }
</style>

<script>
  (function () {
    'use strict';

    const RATING_SCALE = [
      { min: 40, label: 'Superhuman!', color: '#16a34a' },
      { min: 30, label: 'Excellent!', color: '#22c55e' },
      { min: 20, label: 'Good', color: '#2563eb' },
      { min: 10, label: 'Average', color: '#f59e0b' },
      { min: 0, label: 'Below Average', color: '#ef4444' },
    ];

    function getLocalRating(score: number) {
      for (const level of RATING_SCALE) {
        if (score >= level.min) return { label: level.label, color: level.color };
      }
      return { label: 'Below Average', color: '#ef4444' };
    }

    const STORAGE_KEY = 'toolcalcs_color-blindness-test_history';
    const MAX_HISTORY = 20;

    function loadHistory(): Array<{ score: number; date: string; rating: string }> {
      try { const r = localStorage.getItem(STORAGE_KEY); if (r) return JSON.parse(r); } catch {}
      return [];
    }
    function saveHistory(h: Array<{ score: number; date: string; rating: string }>) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(0, MAX_HISTORY))); } catch {}
    }
    function addToHistory(score: number) {
      const h = loadHistory();
      h.unshift({ score, date: new Date().toISOString(), rating: getLocalRating(score).label });
      saveHistory(h);
    }

    // DOM
    const instructionsView = document.getElementById('instructionsView')!;
    const playView = document.getElementById('playView')!;
    const resultView = document.getElementById('resultView')!;
    const startBtn = document.getElementById('startBtn')!;
    const tryAgainBtn = document.getElementById('tryAgainBtn')!;
    const levelInfo = document.getElementById('levelInfo')!;
    const livesInfo = document.getElementById('livesInfo')!;
    const tileGrid = document.getElementById('tileGrid')!;
    const finalScore = document.getElementById('finalScore')!;
    const ratingBadge = document.getElementById('ratingBadge')!;
    const attemptHistorySection = document.getElementById('attemptHistory')!;
    const historyList = document.getElementById('historyList')!;

    let currentLevel = 1;
    let lives = 3;
    let isPlaying = false;

    function showView(view: HTMLElement) {
      [instructionsView, playView, resultView].forEach(v => v.style.display = 'none');
      view.style.display = '';
    }

    function getGridSize(level: number): number {
      if (level <= 2) return 2;
      if (level <= 6) return 3;
      if (level <= 12) return 4;
      if (level <= 20) return 5;
      if (level <= 30) return 6;
      if (level <= 42) return 7;
      return 8;
    }

    function getColorDiff(level: number): number {
      // Start at 50, decrease by ~1.5 per level, minimum 2
      return Math.max(2, 50 - (level - 1) * 1.5);
    }

    function generateRound(level: number) {
      const gridSize = getGridSize(level);
      const diff = getColorDiff(level);
      const totalTiles = gridSize * gridSize;
      const oddIndex = Math.floor(Math.random() * totalTiles);

      // Random base color in HSL
      const h = Math.floor(Math.random() * 360);
      const s = 40 + Math.floor(Math.random() * 35);
      const l = 30 + Math.floor(Math.random() * 25);

      // Direction of lightness shift (brighter or darker)
      const direction = Math.random() > 0.5 ? 1 : -1;
      const oddL = Math.max(10, Math.min(85, l + diff * direction));

      const baseColor = `hsl(${h}, ${s}%, ${l}%)`;
      const oddColor = `hsl(${h}, ${s}%, ${oddL}%)`;

      return { gridSize, totalTiles, oddIndex, baseColor, oddColor };
    }

    function renderGrid() {
      const { gridSize, totalTiles, oddIndex, baseColor, oddColor } = generateRound(currentLevel);

      tileGrid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
      tileGrid.innerHTML = '';

      for (let i = 0; i < totalTiles; i++) {
        const btn = document.createElement('button');
        btn.className = 'color-tile';
        btn.style.background = i === oddIndex ? oddColor : baseColor;
        btn.setAttribute('aria-label', `Tile ${i + 1}`);
        btn.dataset.index = String(i);
        btn.dataset.isOdd = i === oddIndex ? '1' : '0';
        tileGrid.appendChild(btn);
      }

      levelInfo.textContent = `Level ${currentLevel}`;
      livesInfo.textContent = '‚ù§Ô∏è'.repeat(lives);
    }

    function handleTileClick(e: Event) {
      if (!isPlaying) return;
      const target = (e.target as HTMLElement).closest('.color-tile') as HTMLElement | null;
      if (!target) return;

      if (target.dataset.isOdd === '1') {
        // Correct
        target.classList.add('correct-flash');
        currentLevel++;
        setTimeout(() => renderGrid(), 350);
      } else {
        // Wrong
        target.classList.add('wrong-flash');
        lives--;
        livesInfo.textContent = '‚ù§Ô∏è'.repeat(Math.max(0, lives));

        // Briefly highlight the correct tile
        const correctTile = tileGrid.querySelector('[data-is-odd="1"]') as HTMLElement;
        if (correctTile) correctTile.classList.add('correct-flash');

        if (lives <= 0) {
          setTimeout(() => endGame(), 500);
        } else {
          setTimeout(() => renderGrid(), 600);
        }
      }
    }

    function startGame() {
      currentLevel = 1;
      lives = 3;
      isPlaying = true;
      showView(playView);
      renderGrid();
    }

    function endGame() {
      isPlaying = false;
      const score = currentLevel - 1;
      showView(resultView);
      finalScore.textContent = String(score);
      const rating = getLocalRating(score);
      ratingBadge.textContent = rating.label;
      ratingBadge.style.background = rating.color;
      addToHistory(score);
      renderHistory();
    }

    function renderHistory() {
      const history = loadHistory();
      if (history.length === 0) { attemptHistorySection.hidden = true; return; }
      attemptHistorySection.hidden = false;
      historyList.innerHTML = history.map(e => {
        const r = getLocalRating(e.score);
        return `<div class="history-item">
          <span class="history-score">${e.score} levels</span>
          <span class="history-rating" style="background:${r.color}">${r.label}</span>
          <span class="history-time">${formatDate(e.date)}</span>
        </div>`;
      }).join('');
    }

    function formatDate(iso: string): string {
      try { return new Date(iso).toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
      catch { return ''; }
    }

    // Events
    tileGrid.addEventListener('click', handleTileClick);
    startBtn.addEventListener('click', startGame);
    tryAgainBtn.addEventListener('click', startGame);
    renderHistory();
  })();
</script>
