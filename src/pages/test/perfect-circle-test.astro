---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AdUnit from '../../components/AdUnit.astro';
import { getGameBySlug, getRating } from '../../data/games';
import '../../styles/game.css';

const game = getGameBySlug('perfect-circle-test')!;

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://toolcalcs.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Tests & Games",
      "item": "https://toolcalcs.com/test/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Perfect Circle Test"
    }
  ]
};
---

<BaseLayout
  title="Perfect Circle Test - Draw a Perfect Circle Challenge | ToolCalcs"
  description="Can you draw a perfect circle freehand? Test your hand steadiness and motor control. Get scored 0-100% on circularity with instant visual feedback."
  type="article"
  structuredData={structuredData}
>
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="/">Home</a> &rsaquo;
    <a href="/test/">Tests & Games</a> &rsaquo;
    <span>Perfect Circle Test</span>
  </nav>

  <h1>Perfect Circle Test</h1>
  <p class="page-desc">Draw a circle freehand with your mouse or finger and see how close to a perfect circle it is. Your score is based on how consistent the radius is across your entire drawing.</p>

  <div class="game-box">
    <div class="canvas-wrapper" id="canvasWrapper">
      <canvas id="circleCanvas" aria-label="Drawing area for the perfect circle test"></canvas>
      <div class="canvas-prompt" id="canvasPrompt">
        <span class="prompt-icon" aria-hidden="true">&#9711;</span>
        <p>Draw a circle with your mouse or finger</p>
      </div>
    </div>

    <div class="score-display" id="scoreDisplay" style="display:none;">
      <span class="score-value" id="scoreValue">0%</span>
      <span class="score-unit">Circularity Score</span>
      <span class="rating-badge" id="ratingBadge"></span>
    </div>

    <div class="game-controls">
      <button class="game-btn primary" id="tryAgainBtn">Try Again</button>
    </div>

    <div class="attempt-history" id="attemptHistory" style="display:none;">
      <h3>Attempt History</h3>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <AdUnit slot="game-mid" format="rectangle" />

  <article class="content-section">
    <h2>What Is the Perfect Circle Test?</h2>
    <p>The Perfect Circle Test is a simple but surprisingly difficult challenge: draw a freehand circle on screen and receive an instant score from 0 to 100 percent based on how close your shape is to a mathematically perfect circle. While a circle seems like one of the most basic geometric shapes, reproducing one without any guides or tools demands remarkably fine motor coordination. Most people score somewhere between 60 and 85 percent on their first try, and improving beyond 90 percent takes deliberate practice.</p>
    <p>The test works by analyzing the consistency of the radius across every point in your drawing. After you finish your stroke, the algorithm calculates the center of mass of all drawn points, measures the distance from every point to that center, and then evaluates how uniform those distances are. A perfectly uniform set of distances means every part of your circle is exactly the same distance from its center, which is the mathematical definition of a circle.</p>

    <h2>How the Scoring Works</h2>
    <p>Your circularity score is derived from the standard deviation of the distances between each drawn point and the computed center. The lower the standard deviation relative to the average radius, the more consistent your circle is. Specifically, the formula is:</p>
    <p><strong>Score = (1 - standard deviation / average radius) &times; 100</strong></p>
    <p>A standard deviation of zero would mean every single point sits on the exact same radius, producing a score of 100 percent. In practice, even tiny hand tremors or slight oval-like tendencies push the deviation upward and reduce the score. The scoring is strict but fair: it rewards smoothness and symmetry while penalizing flat edges, wobbles, and elliptical shapes equally.</p>

    <h2>Motor Skills and Circle Drawing</h2>
    <p>Drawing a circle involves a complex sequence of fine motor actions. Your brain must coordinate movements across the shoulder, elbow, wrist, and finger joints simultaneously. Research in motor control science shows that circular movements require continuous adjustment of muscle activation patterns because the direction of motion changes at every point along the curve. This makes circles fundamentally harder to draw than straight lines.</p>
    <p>The size of the circle also matters. Very small circles rely primarily on finger and wrist movements, where precision is high but range of motion is limited. Larger circles engage the forearm and shoulder, which offer greater range but less inherent precision. Most people find a medium-sized circle, roughly five to eight centimeters in diameter, to be the sweet spot for achieving a high score.</p>
    <p>Speed is another important factor. Drawing too quickly leads to overshooting curves and angular transitions. Drawing too slowly can introduce waviness as your hand struggles to maintain a steady arc. The ideal speed is a moderate, confident stroke completed in roughly one to two seconds. This pace lets your brain's feedforward motor planning work effectively while still allowing real-time corrections through proprioceptive feedback.</p>

    <h2>Tips for Drawing a Better Circle</h2>
    <p>If you want to improve your score, several techniques can help. First, try pivoting from your wrist or elbow rather than moving your fingers. This produces smoother, more consistent arcs because larger joints have more predictable rotational behavior. Second, start with the intention of closing the circle in a single, unbroken stroke. Hesitation or lifting at any point creates discontinuities that hurt your score.</p>
    <p>Another useful strategy is to visualize the complete circle before you begin drawing. Athletes and musicians call this mental rehearsal or imagery, and research confirms it activates many of the same neural pathways as physical practice. When you picture the full circle, including its size, position, and the motion of your hand, you prime your motor cortex for more accurate execution.</p>
    <p>Practice also matters. Studies on procedural motor learning show that repetitive circle drawing leads to measurable improvements in smoothness and roundness within just a few dozen attempts. The brain gradually optimizes the timing and force of muscle contractions, a process called motor consolidation. So if your first few scores feel disappointing, keep trying. Your neuromuscular system is adapting even when progress feels slow.</p>

    <h2>Who Uses Circle Drawing Tests?</h2>
    <p>Beyond being a fun online challenge, circle drawing tests appear in several professional and clinical contexts. Occupational therapists use freehand circle tasks to assess fine motor coordination in patients recovering from strokes, nerve injuries, or neurological conditions like Parkinson's disease. Deterioration in circle-drawing quality can be an early indicator of motor decline, sometimes appearing before more obvious symptoms.</p>
    <p>Art educators also use circle exercises as foundational drills. The ability to draw smooth, consistent curves is considered a basic prerequisite for illustration, calligraphy, and technical drawing. Many classical art training programs begin with pages of circles, ellipses, and spirals specifically to develop hand control.</p>
    <p>In engineering and design fields, the ability to sketch approximate circles quickly is a valued skill during brainstorming and concept development. While final designs are always created with digital tools, early-stage ideation relies heavily on freehand sketching. A designer who can quickly produce clean, round shapes communicates ideas more effectively in collaborative settings.</p>

    <h2>Frequently Asked Questions</h2>
    <h3>What is a good score on the perfect circle test?</h3>
    <p>A score above 85 percent is considered excellent for most people. Professional artists and people with highly developed fine motor skills sometimes reach 90 to 95 percent. Scores above 95 percent are rare and indicate near-perfect hand control.</p>

    <h3>Does drawing speed affect my score?</h3>
    <p>Yes. Drawing too fast tends to produce angular shapes, while drawing too slowly introduces waviness. A moderate, confident speed of about one to two seconds per circle typically yields the best results.</p>

    <h3>Is it easier with a mouse or touchscreen?</h3>
    <p>This depends on the individual. Some people find touchscreens more intuitive because they use natural hand movements similar to drawing on paper. Others prefer a mouse because it rests on a stable surface. Try both and see which gives you higher scores.</p>

    <h3>Can I improve my score with practice?</h3>
    <p>Absolutely. Motor learning research shows measurable improvement within just a few dozen attempts. Your brain optimizes muscle coordination through repetition, and most people see their scores climb steadily over their first 10 to 20 tries.</p>
  </article>

  <AdUnit slot="game-bottom" format="horizontal" />
</BaseLayout>

<style>
  .canvas-wrapper {
    position: relative;
    width: 100%;
    max-width: 500px;
    aspect-ratio: 1;
    margin: 0 auto 24px;
    border-radius: var(--radius);
    border: 2px solid var(--color-border);
    overflow: hidden;
    cursor: crosshair;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
    background:
      linear-gradient(to right, rgba(0,0,0,0.03) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(0,0,0,0.03) 1px, transparent 1px),
      #ffffff;
    background-size: 25px 25px;
  }
  .canvas-wrapper canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
  .canvas-prompt {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    color: var(--color-text-muted);
    transition: opacity 0.2s;
  }
  .canvas-prompt.hidden {
    opacity: 0;
  }
  .prompt-icon {
    font-size: 4rem;
    opacity: 0.25;
    line-height: 1;
    margin-bottom: 12px;
  }
  .canvas-prompt p {
    font-size: 0.95rem;
    margin: 0;
  }
  @media (max-width: 640px) {
    .canvas-wrapper {
      max-width: 100%;
    }
  }
</style>

<script>
  interface HistoryEntry {
    score: number;
    rating: string;
    color: string;
    timestamp: number;
  }

  const STORAGE_KEY = 'toolcalcs_perfect-circle-test_history';
  const MAX_HISTORY = 20;

  // Rating scale matching games.ts for client-side use
  const ratingScale = [
    { max: 50, label: 'Rough', color: '#ef4444' },
    { max: 70, label: 'Okay', color: '#f59e0b' },
    { max: 85, label: 'Good', color: '#2563eb' },
    { max: 95, label: 'Great!', color: '#22c55e' },
    { max: Infinity, label: 'Perfect!', color: '#16a34a' },
  ];

  function getClientRating(score: number): { label: string; color: string } {
    for (let i = ratingScale.length - 1; i >= 0; i--) {
      if (i === 0) return ratingScale[0];
      const prev = ratingScale[i - 1];
      if (score >= prev.max) return ratingScale[i];
    }
    return ratingScale[0];
  }

  // DOM elements
  const canvas = document.getElementById('circleCanvas') as HTMLCanvasElement;
  const wrapper = document.getElementById('canvasWrapper') as HTMLDivElement;
  const prompt = document.getElementById('canvasPrompt') as HTMLDivElement;
  const scoreDisplay = document.getElementById('scoreDisplay') as HTMLDivElement;
  const scoreValue = document.getElementById('scoreValue') as HTMLSpanElement;
  const ratingBadge = document.getElementById('ratingBadge') as HTMLSpanElement;
  const tryAgainBtn = document.getElementById('tryAgainBtn') as HTMLButtonElement;
  const attemptHistory = document.getElementById('attemptHistory') as HTMLDivElement;
  const historyList = document.getElementById('historyList') as HTMLDivElement;

  // Canvas setup with high-DPI support
  const ctx = canvas.getContext('2d')!;
  let dpr = window.devicePixelRatio || 1;
  let points: { x: number; y: number }[] = [];
  let isDrawing = false;
  let hasDrawn = false;

  function resizeCanvas() {
    dpr = window.devicePixelRatio || 1;
    const rect = wrapper.getBoundingClientRect();
    const w = rect.width;
    const h = rect.height;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  resizeCanvas();
  window.addEventListener('resize', () => {
    resizeCanvas();
    if (hasDrawn && points.length > 0) {
      redrawResult();
    }
  });

  function getPos(e: MouseEvent | Touch): { x: number; y: number } {
    const rect = canvas.getBoundingClientRect();
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top,
    };
  }

  function clearCanvas() {
    const rect = wrapper.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);
  }

  function drawStroke() {
    if (points.length < 2) return;
    ctx.beginPath();
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < points.length; i++) {
      ctx.lineTo(points[i].x, points[i].y);
    }
    ctx.stroke();
  }

  // --- Start drawing ---
  function startDraw(pos: { x: number; y: number }) {
    if (hasDrawn) return;
    isDrawing = true;
    points = [pos];
    prompt.classList.add('hidden');
    clearCanvas();
  }

  function moveDraw(pos: { x: number; y: number }) {
    if (!isDrawing) return;
    points.push(pos);
    clearCanvas();
    drawStroke();
  }

  function endDraw() {
    if (!isDrawing) return;
    isDrawing = false;
    if (points.length < 10) {
      // Not enough points to evaluate
      points = [];
      prompt.classList.remove('hidden');
      clearCanvas();
      return;
    }
    hasDrawn = true;
    calculateAndShow();
  }

  // --- Mouse events ---
  canvas.addEventListener('mousedown', (e) => {
    e.preventDefault();
    startDraw(getPos(e));
  });
  canvas.addEventListener('mousemove', (e) => {
    e.preventDefault();
    moveDraw(getPos(e));
  });
  canvas.addEventListener('mouseup', (e) => {
    e.preventDefault();
    endDraw();
  });
  canvas.addEventListener('mouseleave', () => {
    if (isDrawing) endDraw();
  });

  // --- Touch events ---
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (e.touches.length === 1) {
      startDraw(getPos(e.touches[0]));
    }
  }, { passive: false });
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (e.touches.length === 1) {
      moveDraw(getPos(e.touches[0]));
    }
  }, { passive: false });
  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    endDraw();
  }, { passive: false });
  canvas.addEventListener('touchcancel', () => {
    if (isDrawing) endDraw();
  });

  // --- Scoring ---
  function calculateScore(): number {
    if (points.length < 10) return 0;

    // 1. Find center (average x, average y)
    let sumX = 0;
    let sumY = 0;
    for (const p of points) {
      sumX += p.x;
      sumY += p.y;
    }
    const centerX = sumX / points.length;
    const centerY = sumY / points.length;

    // 2. Calculate distance from each point to center
    const distances: number[] = [];
    for (const p of points) {
      const dx = p.x - centerX;
      const dy = p.y - centerY;
      distances.push(Math.sqrt(dx * dx + dy * dy));
    }

    // 3. Average radius
    let sumDist = 0;
    for (const d of distances) {
      sumDist += d;
    }
    const avgRadius = sumDist / distances.length;

    if (avgRadius < 5) return 0; // Circle too small

    // 4. Standard deviation of distances
    let sumSqDiff = 0;
    for (const d of distances) {
      const diff = d - avgRadius;
      sumSqDiff += diff * diff;
    }
    const stdDev = Math.sqrt(sumSqDiff / distances.length);

    // 5. Score
    const score = Math.max(0, Math.round((1 - stdDev / avgRadius) * 100));
    return score;
  }

  function getCircleParams(): { cx: number; cy: number; radius: number } {
    let sumX = 0;
    let sumY = 0;
    for (const p of points) {
      sumX += p.x;
      sumY += p.y;
    }
    const cx = sumX / points.length;
    const cy = sumY / points.length;

    let sumDist = 0;
    for (const p of points) {
      const dx = p.x - cx;
      const dy = p.y - cy;
      sumDist += Math.sqrt(dx * dx + dy * dy);
    }
    const radius = sumDist / points.length;

    return { cx, cy, radius };
  }

  function redrawResult() {
    clearCanvas();
    drawStroke();

    const { cx, cy, radius } = getCircleParams();

    // Draw perfect circle overlay (dashed green)
    ctx.beginPath();
    ctx.setLineDash([8, 6]);
    ctx.strokeStyle = '#22c55e';
    ctx.lineWidth = 2;
    ctx.arc(cx, cy, radius, 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);

    // Draw center point (small red dot)
    ctx.beginPath();
    ctx.fillStyle = '#ef4444';
    ctx.arc(cx, cy, 4, 0, Math.PI * 2);
    ctx.fill();
  }

  function calculateAndShow() {
    const score = calculateScore();
    redrawResult();

    // Show score
    scoreValue.textContent = score + '%';
    const rating = getClientRating(score);
    ratingBadge.textContent = rating.label;
    ratingBadge.style.backgroundColor = rating.color;
    scoreDisplay.style.display = '';

    // Save to history
    saveToHistory(score, rating.label, rating.color);
    renderHistory();
  }

  // --- Try Again ---
  tryAgainBtn.addEventListener('click', () => {
    hasDrawn = false;
    isDrawing = false;
    points = [];
    clearCanvas();
    prompt.classList.remove('hidden');
    scoreDisplay.style.display = 'none';
  });

  // --- History ---
  function loadHistory(): HistoryEntry[] {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      return JSON.parse(raw) as HistoryEntry[];
    } catch {
      return [];
    }
  }

  function saveToHistory(score: number, rating: string, color: string) {
    const history = loadHistory();
    history.unshift({ score, rating, color, timestamp: Date.now() });
    if (history.length > MAX_HISTORY) history.length = MAX_HISTORY;
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    } catch {
      // Storage full or unavailable
    }
  }

  function formatTime(ts: number): string {
    const d = new Date(ts);
    const now = new Date();
    const diffMs = now.getTime() - d.getTime();
    const diffMin = Math.floor(diffMs / 60000);
    if (diffMin < 1) return 'Just now';
    if (diffMin < 60) return diffMin + 'm ago';
    const diffHr = Math.floor(diffMin / 60);
    if (diffHr < 24) return diffHr + 'h ago';
    const diffDay = Math.floor(diffHr / 24);
    if (diffDay < 7) return diffDay + 'd ago';
    return d.toLocaleDateString();
  }

  function renderHistory() {
    const history = loadHistory();
    if (history.length === 0) {
      attemptHistory.style.display = 'none';
      return;
    }
    attemptHistory.style.display = '';
    historyList.innerHTML = '';
    for (const entry of history) {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML =
        '<span class="history-score">' + entry.score + '%</span>' +
        '<span class="history-rating" style="background:' + entry.color + '">' + entry.rating + '</span>' +
        '<span class="history-time">' + formatTime(entry.timestamp) + '</span>';
      historyList.appendChild(item);
    }
  }

  // Initial render
  renderHistory();
</script>
